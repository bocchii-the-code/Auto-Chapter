<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Video Analyzer</title>
  <style>
    :root {
      --bg: #020617;
      --bg-elevated: rgba(15, 23, 42, 0.92);
      --bg-soft: rgba(15, 23, 42, 0.7);
      --border-subtle: rgba(148, 163, 184, 0.35);
      --accent: #38bdf8;
      --accent-strong: #0ea5e9;
      --accent-soft: rgba(56, 189, 248, 0.16);
      --accent-soft-stronger: rgba(56, 189, 248, 0.28);
      --text-main: #e5e7eb;
      --text-muted: #94a3b8;
      --text-soft: #64748b;
      --error: #f97373;
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.8);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Fira Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      background:
        radial-gradient(circle at 0% 0%, rgba(56, 189, 248, 0.12), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(34, 197, 94, 0.09), transparent 55%),
        linear-gradient(135deg, #020617, #020617 40%, #020617 100%);
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    .app-shell {
      width: 100%;
      max-width: 1120px;
      padding: 24px 16px 32px;
    }

    header {
      margin-bottom: 18px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    h1 {
      font-size: 26px;
      letter-spacing: 0.04em;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 3px 9px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: var(--text-muted);
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: radial-gradient(circle, #22c55e, #16a34a);
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.18);
    }

    .subtitle {
      margin: 0;
      font-size: 13px;
      color: var(--text-muted);
      max-width: 560px;
    }

    .layout-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.4fr);
      gap: 18px;
    }

    @media (max-width: 900px) {
      .layout-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: var(--bg-elevated);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      padding: 18px 18px 16px;
      backdrop-filter: blur(26px);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
    }

    .card-title {
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-soft);
    }

    .card-hint {
      font-size: 11px;
      color: var(--text-muted);
    }

    .upload-card {
      position: relative;
      overflow: hidden;
    }

    .upload-card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 0% 0%, rgba(56, 189, 248, 0.16), transparent 60%);
      opacity: 0.9;
      pointer-events: none;
    }

    .upload-inner {
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 14px;
      z-index: 1;
    }

    .dropzone {
      border-radius: var(--radius-md);
      border: 1px dashed rgba(148, 163, 184, 0.6);
      padding: 18px 16px;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.92));
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      cursor: pointer;
      transition: border-color 0.16s ease, background 0.16s ease, transform 0.12s ease;
    }

    .dropzone-main {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .dropzone-title {
      font-size: 14px;
      font-weight: 500;
    }

    .dropzone-sub {
      font-size: 12px;
      color: var(--text-muted);
    }

    .dropzone-extra {
      font-size: 11px;
      color: var(--text-soft);
    }

    .dropzone-cta {
      padding: 7px 13px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.65);
      font-size: 11px;
      color: var(--text-main);
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.98));
    }

    .dropzone.dragging {
      border-color: var(--accent);
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.98));
      transform: translateY(-1px);
    }

    .dropzone.dragging .dropzone-cta {
      border-color: var(--accent);
      background: linear-gradient(135deg, var(--accent-soft), rgba(15, 23, 42, 0.96));
      color: #e0f2fe;
    }

    .settings-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .settings-field {
      flex: 1 1 220px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .settings-field label {
      font-size: 11px;
      color: var(--text-muted);
    }

    .settings-field input {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.96);
      color: var(--text-main);
      font-size: 12px;
      padding: 7px 11px;
      outline: none;
    }

    .settings-field input::placeholder {
      color: var(--text-soft);
    }

    .settings-field input:focus {
      border-color: var(--accent-strong);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.7);
    }

    .upload-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .slider-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1 1 220px;
    }

    .slider-label {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .slider-label span:last-child {
      color: var(--text-soft);
    }

    input[type="range"] {
      width: 100%;
      accent-color: var(--accent-strong);
    }

    .primary-btn {
      border-radius: 999px;
      border: none;
      padding: 9px 18px;
      font-size: 13px;
      font-weight: 500;
      color: #0b1120;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      box-shadow: 0 12px 30px rgba(56, 189, 248, 0.35);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
      transition: transform 0.14s ease, box-shadow 0.14s ease, filter 0.14s ease;
    }

    .primary-btn span {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }

    .primary-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 38px rgba(56, 189, 248, 0.5);
      filter: brightness(1.02);
    }

    .primary-btn:active {
      transform: translateY(0);
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.8);
    }

    .status-bar {
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.96));
      border: 1px solid rgba(51, 65, 85, 0.9);
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: radial-gradient(circle, var(--accent-strong), var(--accent));
      box-shadow: 0 0 0 5px var(--accent-soft);
      flex-shrink: 0;
    }

    .spinner {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 999px;
      border: 2px solid rgba(148, 163, 184, 0.4);
      border-top-color: var(--accent-strong);
      animation: spin 0.6s linear infinite;
      flex-shrink: 0;
    }

    .status-text {
      flex: 1;
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .status-text.error {
      color: var(--error);
    }

    .status-meta {
      font-size: 10px;
      color: var(--text-soft);
    }

    .results-card {
      display: flex;
      flex-direction: column;
      gap: 14px;
      background: linear-gradient(145deg, var(--bg-elevated), var(--bg-soft));
    }

    .results-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.2fr);
      gap: 14px;
    }

    @media (max-width: 900px) {
      .results-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .results-section {
      border-radius: var(--radius-md);
      border: 1px solid rgba(51, 65, 85, 0.95);
      background: radial-gradient(circle at 0% 0%, rgba(56, 189, 248, 0.1), transparent 60%),
                  linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.94));
      padding: 12px 12px 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .results-section h2 {
      margin: 0;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--text-soft);
    }

    .results-section small {
      font-size: 11px;
      color: var(--text-muted);
    }

    .summary-body {
      font-size: 13px;
      line-height: 1.6;
      color: var(--text-main);
      max-height: 260px;
      overflow: auto;
      padding-right: 4px;
    }

    .summary-body::-webkit-scrollbar,
    .chapters-list::-webkit-scrollbar,
    .transcript-body::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    .summary-body::-webkit-scrollbar-thumb,
    .chapters-list::-webkit-scrollbar-thumb,
    .transcript-body::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.6);
      border-radius: 999px;
    }

    .summary-body::-webkit-scrollbar-track,
    .chapters-list::-webkit-scrollbar-track,
    .transcript-body::-webkit-scrollbar-track {
      background: transparent;
    }

    .timeline-wrapper {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .timeline-bar {
      position: relative;
      height: 18px;
      border-radius: 999px;
      background: radial-gradient(circle at 0% 0%, rgba(148, 163, 184, 0.23), transparent 65%),
        radial-gradient(circle at 100% 0%, rgba(56, 189, 248, 0.24), transparent 70%),
        linear-gradient(90deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.96));
      padding: 2px;
      display: flex;
      overflow: hidden;
      gap: 2px;
    }

    .chapter-block {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--accent-soft-stronger), var(--accent-strong));
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.9), 0 10px 30px rgba(56, 189, 248, 0.55);
      cursor: pointer;
      position: relative;
      transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.12s ease;
      min-width: 5%;
    }

    .chapter-block::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 0% 0%, rgba(248, 250, 252, 0.55), transparent 55%);
      mix-blend-mode: screen;
      opacity: 0.8;
      pointer-events: none;
    }

    .chapter-block:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 0 1px rgba(148, 163, 184, 0.9), 0 12px 32px rgba(56, 189, 248, 0.8);
      opacity: 1;
    }

    .chapters-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .chapter-item {
      display: grid;
      grid-template-columns: auto minmax(0, 1fr);
      gap: 8px;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid rgba(51, 65, 85, 0.9);
      background: linear-gradient(120deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.94));
      cursor: default;
      transition: border-color 0.12s ease, background 0.12s ease, transform 0.12s ease;
    }

    .chapter-item:hover {
      border-color: rgba(56, 189, 248, 0.9);
      background: linear-gradient(120deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.98));
      transform: translateY(-1px);
    }

    .chapter-item.active {
      border-color: var(--accent-strong);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.65);
    }

    .chapter-time {
      font-size: 11px;
      color: var(--accent);
      padding-top: 2px;
      white-space: nowrap;
    }

    .chapter-body {
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .chapter-title {
      font-size: 13px;
      font-weight: 500;
      color: #e0f2fe;
    }

    .chapter-desc {
      font-size: 11px;
      color: var(--text-muted);
    }

    .chapter-points {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 2px;
    }

    .chapter-tag {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.45);
      color: var(--text-soft);
    }

    .transcript-body {
      font-size: 11px;
      line-height: 1.5;
      color: var(--text-muted);
      max-height: 240px;
      overflow: auto;
      padding-right: 4px;
      white-space: pre-wrap;
    }

    .results-meta-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 4px;
    }

    .hidden {
      display: none !important;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="title-row">
        <h1>
          Video Analyzer
          <span class="pill">
            <span class="pill-dot"></span>
            Whisper + GPT chapters
          </span>
        </h1>
      </div>
      <p class="subtitle">
        Upload a lecture, podcast or any long video. The backend will run your existing pipeline.py to transcribe it, summarize it and cut it into chapters.
      </p>
    </header>

    <div class="layout-grid">
      <section class="card upload-card">
        <div class="card-header">
          <div class="card-title">Upload</div>
          <div class="card-hint">MP4 / MOV or any common video format</div>
        </div>
        <div class="upload-inner">
          <form id="upload-form">
            <input id="video-input" type="file" accept="video/*" hidden />

            <div id="drop-zone" class="dropzone">
              <div class="dropzone-main">
                <div class="dropzone-title" id="file-label">Drop a video here, or click to choose a file</div>
                <div class="dropzone-sub">The file stays on this machine and is processed via pipeline.py.</div>
                <div class="dropzone-extra">Long videos can take several minutes to process.</div>
              </div>
              <button type="button" class="dropzone-cta">Choose file</button>
            </div>

            <div class="settings-row">
              <div class="settings-field">
                <label for="api-key">API key</label>
                <input id="api-key" type="password" autocomplete="off" placeholder="sk-..." />
              </div>
              <div class="settings-field">
                <label for="api-base-url">API base URL</label>
                <input id="api-base-url" type="text" placeholder="https://api.openai.com/v1" />
              </div>
            </div>

            <div class="upload-controls">
              <div class="slider-group">
                <label class="slider-label" for="chunk-seconds">
                  <span>Chunk length</span>
                  <span><span id="chunk-label">600</span> seconds per chunk</span>
                </label>
                <input id="chunk-seconds" name="chunk-seconds" type="range" min="300" max="1200" step="60" value="600" />
              </div>

              <button class="primary-btn" type="submit">
                <strong>Start analysis</strong>
                <span>RUN PIPELINE</span>
              </button>
            </div>

            <div class="status-bar">
              <div class="status-dot" id="status-dot"></div>
              <div class="spinner hidden" id="status-spinner"></div>
              <div class="status-text" id="status-text">Waiting for a video file...</div>
              <div class="status-meta">Backend command: python pipeline.py --video ...</div>
            </div>
          </form>
        </div>
      </section>

      <section class="card results-card" id="results-card">
        <div class="card-header">
          <div class="card-title">Analysis</div>
          <div class="card-hint">Summary, chapters and transcript preview will appear here.</div>
        </div>
        <div id="results" class="hidden">
          <div class="results-grid">
            <div class="results-section">
              <h2>Summary</h2>
              <small>High level overview of the content.</small>
              <div class="summary-body" id="summary-content">No summary yet.</div>
            </div>

            <div class="results-section">
              <h2>Timeline and chapters</h2>
              <small>Chapters represented as blocks on a single timeline.</small>
              <div class="timeline-wrapper">
                <div class="timeline-bar" id="timeline-bar"></div>
                <ul class="chapters-list" id="chapters-list"></ul>
              </div>
            </div>
          </div>

          <div class="results-section" style="margin-top: 10px;">
            <h2>Transcript preview</h2>
            <small>Only the first few thousand characters are shown. The full transcript is stored in the output directory.</small>
            <div class="transcript-body" id="transcript-content">No transcript yet.</div>
            <div class="results-meta-row">
              <div id="stats">No analysis has been run yet.</div>
              <div>Generated files: transcript.txt, segments.json, summary.md, chapters.json, chapters.md</div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    (function () {
      var form = document.getElementById('upload-form');
      var fileInput = document.getElementById('video-input');
      var dropZone = document.getElementById('drop-zone');
      var fileLabel = document.getElementById('file-label');
      var chunkSlider = document.getElementById('chunk-seconds');
      var chunkLabel = document.getElementById('chunk-label');
      var statusText = document.getElementById('status-text');
      var statusSpinner = document.getElementById('status-spinner');
      var resultsSection = document.getElementById('results');
      var summaryEl = document.getElementById('summary-content');
      var transcriptEl = document.getElementById('transcript-content');
      var chaptersListEl = document.getElementById('chapters-list');
      var timelineBarEl = document.getElementById('timeline-bar');
      var statsEl = document.getElementById('stats');
      var apiKeyInput = document.getElementById('api-key');
      var apiBaseUrlInput = document.getElementById('api-base-url');

      var LS_KEY = 'video-ui-api-key';
      var LS_BASE = 'video-ui-api-base-url';

      try {
        var savedKey = localStorage.getItem(LS_KEY) || '';
        var savedBase = localStorage.getItem(LS_BASE) || '';
        if (savedKey) apiKeyInput.value = savedKey;
        if (savedBase) apiBaseUrlInput.value = savedBase;
      } catch (e) {
        // ignore
      }

      chunkSlider.addEventListener('input', function () {
        chunkLabel.textContent = this.value;
      });

      dropZone.addEventListener('click', function () {
        fileInput.click();
      });

      fileInput.addEventListener('change', function () {
        if (fileInput.files && fileInput.files[0]) {
          fileLabel.textContent = 'Selected: ' + fileInput.files[0].name;
        } else {
          fileLabel.textContent = 'Drop a video here, or click to choose a file';
        }
      });

      ['dragenter', 'dragover'].forEach(function (eventName) {
        dropZone.addEventListener(eventName, function (e) {
          e.preventDefault();
          e.stopPropagation();
          dropZone.classList.add('dragging');
        });
      });

      ['dragleave', 'drop'].forEach(function (eventName) {
        dropZone.addEventListener(eventName, function (e) {
          e.preventDefault();
          e.stopPropagation();
          dropZone.classList.remove('dragging');
        });
      });

      dropZone.addEventListener('drop', function (e) {
        var dt = e.dataTransfer;
        if (!dt) return;
        var files = dt.files;
        if (files && files[0]) {
          fileInput.files = files;
          fileLabel.textContent = 'Selected: ' + files[0].name;
        }
      });

      function setStatus(message, isLoading, isError) {
        statusText.textContent = message;
        if (isError) {
          statusText.classList.add('error');
        } else {
          statusText.classList.remove('error');
        }
        statusSpinner.classList.toggle('hidden', !isLoading);
      }

      function secondsToClock(totalSeconds) {
        totalSeconds = Math.round(totalSeconds || 0);
        var h = Math.floor(totalSeconds / 3600);
        var m = Math.floor((totalSeconds % 3600) / 60);
        var s = totalSeconds % 60;
        if (h > 0) {
          return String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
        }
        return String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
      }

      function parseTimecode(value) {
        if (value === null || value === undefined) return 0;
        var str = String(value).trim();
        if (!str) return 0;
        var parts = str.split(':').map(Number);
        if (parts.length === 3) {
          return parts[0] * 3600 + parts[1] * 60 + parts[2];
        }
        if (parts.length === 2) {
          return parts[0] * 60 + parts[1];
        }
        var num = Number(str);
        return isFinite(num) ? num : 0;
      }

      function getDurationFromSegments(segments) {
        if (!Array.isArray(segments) || segments.length === 0) return 0;
        var maxEnd = 0;
        for (var i = 0; i < segments.length; i++) {
          var seg = segments[i];
          if (typeof seg.end === 'number' && seg.end > maxEnd) {
            maxEnd = seg.end;
          }
        }
        return maxEnd;
      }

      function highlightChapter(index) {
        var items = chaptersListEl.querySelectorAll('.chapter-item');
        items.forEach(function (el, i) {
          if (i === index) {
            el.classList.add('active');
          } else {
            el.classList.remove('active');
          }
        });
      }

      function renderResults(data) {
        resultsSection.classList.remove('hidden');

        var summary = data && data.summary ? data.summary : 'No summary available.';
        summaryEl.textContent = summary;

        var transcriptPreview = data && data.transcript_preview ? data.transcript_preview : 'No transcript available.';
        transcriptEl.textContent = transcriptPreview;

        var chapters = Array.isArray(data && data.chapters) ? data.chapters : [];
        var segments = Array.isArray(data && data.segments) ? data.segments : [];

        var totalDuration = getDurationFromSegments(segments);

        var chapterCount = chapters.length;
        var durationText = totalDuration > 0 ? secondsToClock(totalDuration) : 'unknown length';
        statsEl.textContent = 'Chapters: ' + chapterCount + '  |  Estimated length: ' + durationText;

        timelineBarEl.innerHTML = '';
        if (chapters.length === 0) {
          var placeholder = document.createElement('div');
          placeholder.style.width = '100%';
          placeholder.style.opacity = '0.35';
          placeholder.className = 'chapter-block';
          timelineBarEl.appendChild(placeholder);
        } else {
          chapters.forEach(function (ch, index) {
            var start = parseTimecode(ch.start || ch.begin || 0);
            var end = parseTimecode(ch.end || ch.stop || totalDuration || 0);
            var duration = Math.max(0, end - start);
            var widthPct = totalDuration > 0 ? (duration / totalDuration) * 100 : (100 / chapters.length);
            var block = document.createElement('div');
            block.className = 'chapter-block';
            block.style.width = Math.max(5, widthPct) + '%';
            block.dataset.index = String(index);
            var startLabel = ch.start || 'unknown';
            var endLabel = ch.end || 'unknown';
            block.title = '[' + startLabel + ' - ' + endLabel + '] ' + (ch.title || 'Chapter');
            block.addEventListener('mouseenter', function () {
              highlightChapter(index);
            });
            timelineBarEl.appendChild(block);
          });
        }

        chaptersListEl.innerHTML = '';
        if (chapters.length === 0) {
          var empty = document.createElement('li');
          empty.className = 'chapter-item';
          empty.textContent = 'No chapters were generated. The LLM output may not have matched the expected schema.';
          chaptersListEl.appendChild(empty);
        } else {
          chapters.forEach(function (ch, index) {
            var li = document.createElement('li');
            li.className = 'chapter-item';

            var time = document.createElement('div');
            time.className = 'chapter-time';
            var startLabel2 = ch.start || '??:??';
            var endLabel2 = ch.end || '';
            time.textContent = endLabel2 ? '[' + startLabel2 + ' - ' + endLabel2 + ']' : '[' + startLabel2 + ']';

            var body = document.createElement('div');
            body.className = 'chapter-body';

            var title = document.createElement('div');
            title.className = 'chapter-title';
            title.textContent = ch.title || 'Untitled chapter';

            var desc = document.createElement('div');
            desc.className = 'chapter-desc';
            desc.textContent = ch.description || 'No description.';

            body.appendChild(title);
            body.appendChild(desc);

            if (Array.isArray(ch.key_points) && ch.key_points.length) {
              var pointsWrap = document.createElement('div');
              pointsWrap.className = 'chapter-points';
              ch.key_points.forEach(function (kp) {
                var tag = document.createElement('span');
                tag.className = 'chapter-tag';
                tag.textContent = kp;
                pointsWrap.appendChild(tag);
              });
              body.appendChild(pointsWrap);
            }

            li.appendChild(time);
            li.appendChild(body);

            li.addEventListener('mouseenter', function () {
              highlightChapter(index);
            });

            chaptersListEl.appendChild(li);
          });
        }
      }

      form.addEventListener('submit', function (e) {
        e.preventDefault();
        var file = fileInput.files && fileInput.files[0];
        if (!file) {
          setStatus('Please choose a video file first.', false, true);
          return;
        }

        var chunkSeconds = Number(chunkSlider.value || '600');
        var apiKey = apiKeyInput.value.trim();
        var apiBaseUrl = apiBaseUrlInput.value.trim();

        try {
          if (apiKey) {
            localStorage.setItem(LS_KEY, apiKey);
          } else {
            localStorage.removeItem(LS_KEY);
          }
          if (apiBaseUrl) {
            localStorage.setItem(LS_BASE, apiBaseUrl);
          } else {
            localStorage.removeItem(LS_BASE);
          }
        } catch (e) {
          // ignore storage errors
        }

        var formData = new FormData();
        formData.append('file', file);
        formData.append('chunk_seconds', String(chunkSeconds));
        formData.append('api_key', apiKey);
        formData.append('api_base_url', apiBaseUrl);

        setStatus('Uploading and analyzing video. This can take several minutes for long files...', true, false);
        resultsSection.classList.add('hidden');

        fetch('/api/process', {
          method: 'POST',
          body: formData,
        })
          .then(function (resp) {
            if (!resp.ok) {
              return resp.json().then(
                function (data) {
                  throw new Error((data && data.detail) || ('Server error: ' + resp.status));
                },
                function () {
                  throw new Error('Server error: ' + resp.status);
                }
              );
            }
            return resp.json();
          })
          .then(function (data) {
            renderResults(data || {});
            setStatus('Analysis finished. See results on the right.', false, false);
          })
          .catch(function (err) {
            console.error(err);
            setStatus(err.message || 'Request failed. Please check that the backend is running.', false, true);
          });
      });
    })();
  </script>
</body>
</html>
